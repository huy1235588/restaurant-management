# Docker Compose for Production Environment
# Optimized builds with multi-stage Dockerfiles

services:
    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: restaurant_postgres_prod
        restart: always
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        volumes:
            - postgres_data_prod:/var/lib/postgresql/data
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Redis Cache
    redis:
        image: redis:7-alpine
        container_name: restaurant_redis_prod
        restart: always
        command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
        ports:
            - "${REDIS_PORT:-6379}:6379"
        volumes:
            - redis_data_prod:/data
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    # Backend Server (NestJS)
    server:
        build:
            context: ../app/server
            dockerfile: Dockerfile
        container_name: restaurant_server_prod
        restart: always
        ports:
            - "${SERVER_PORT:-5000}:5000"
        environment:
            NODE_ENV: production
            PORT: 5000
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public
            REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
            JWT_SECRET: ${JWT_SECRET}
            JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
            JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
            API_VERSION: ${API_VERSION:-v1}
            CORS_ORIGIN: ${CORS_ORIGIN}
            STORAGE_TYPE: ${STORAGE_TYPE:-r2}
            CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
            CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
            CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
            R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
            R2_BUCKET_NAME: ${R2_BUCKET_NAME}
            R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
            R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
            R2_PUBLIC_URL: ${R2_PUBLIC_URL}
        volumes:
            - server_uploads_prod:/app/uploads
        networks:
            - restaurant_network
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5000/api/v1/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Frontend Client (Next.js)
    client:
        build:
            context: ../app/client
            dockerfile: Dockerfile
        container_name: restaurant_client_prod
        restart: always
        ports:
            - "${CLIENT_PORT:-3000}:3000"
        environment:
            NODE_ENV: production
            NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
            NEXT_PUBLIC_SOCKET_URL: ${NEXT_PUBLIC_SOCKET_URL}
            NEXT_TELEMETRY_DISABLED: 1
        networks:
            - restaurant_network
        depends_on:
            server:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    # Nginx Reverse Proxy (Optional - for production SSL/load balancing)
    nginx:
        image: nginx:alpine
        container_name: restaurant_nginx_prod
        restart: always
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ../nginx/ssl:/etc/nginx/ssl:ro
        networks:
            - restaurant_network
        depends_on:
            - client
            - server
        profiles:
            - with-nginx

networks:
    restaurant_network:
        driver: bridge

volumes:
    postgres_data_prod:
        driver: local
    redis_data_prod:
        driver: local
    server_uploads_prod:
        driver: local
