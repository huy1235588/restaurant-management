# Docker Compose for Development Environment
# Complete stack with hot reload for both client and server

services:
    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: restaurant_postgres_dev
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-restaurant_admin}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-restaurant_password}
            POSTGRES_DB: ${POSTGRES_DB:-restaurant_db}
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        volumes:
            - postgres_data_dev:/var/lib/postgresql/data
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-restaurant_admin} -d ${POSTGRES_DB:-restaurant_db}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Redis Cache
    redis:
        image: redis:7-alpine
        container_name: restaurant_redis_dev
        restart: unless-stopped
        command: redis-server --appendonly yes
        ports:
            - "${REDIS_PORT:-6379}:6379"
        volumes:
            - redis_data_dev:/data
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    # Backend Server (NestJS)
    server:
        build:
            context: ../app/server
            dockerfile: Dockerfile.dev
        container_name: restaurant_server_dev
        restart: unless-stopped
        ports:
            - "${SERVER_PORT:-5000}:5000"
        environment:
            NODE_ENV: development
            PORT: 5000
            DATABASE_URL: postgresql://${POSTGRES_USER:-restaurant_admin}:${POSTGRES_PASSWORD:-restaurant_password}@postgres:5432/${POSTGRES_DB:-restaurant_db}?schema=public
            REDIS_URL: redis://redis:6379
            JWT_SECRET: ${JWT_SECRET}
            JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
            JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
            API_VERSION: ${API_VERSION:-v1}
            CORS_ORIGIN: ${CLIENT_URL:-http://localhost:3000}
            STORAGE_TYPE: ${STORAGE_TYPE:-local}
            CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
            CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
            CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
            R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
            R2_BUCKET_NAME: ${R2_BUCKET_NAME}
            R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
            R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
            R2_PUBLIC_URL: ${R2_PUBLIC_URL}
        volumes:
            - ../app/server/src:/app/src:ro
            - ../app/server/prisma:/app/prisma:ro
            - server_uploads_dev:/app/uploads
            - /app/node_modules
            - /app/dist
        networks:
            - restaurant_network
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5000/api/v1/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Frontend Client (Next.js)
    client:
        build:
            context: ../app/client
            dockerfile: Dockerfile.dev
        container_name: restaurant_client_dev
        restart: unless-stopped
        ports:
            - "${CLIENT_PORT:-3000}:3000"
        environment:
            NODE_ENV: development
            NEXT_PUBLIC_API_URL: http://localhost:${SERVER_PORT:-5000}/api/${API_VERSION:-v1}
            NEXT_PUBLIC_SOCKET_URL: http://localhost:${SERVER_PORT:-5000}
            NEXT_TELEMETRY_DISABLED: 1
        volumes:
            - ../app/client/src:/app/src:ro
            - ../app/client/public:/app/public:ro
            - ../app/client/locales:/app/locales:ro
            - /app/node_modules
            - /app/.next
        networks:
            - restaurant_network
        depends_on:
            - server
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

networks:
    restaurant_network:
        driver: bridge

volumes:
    postgres_data_dev:
        driver: local
    redis_data_dev:
        driver: local
    server_uploads_dev:
        driver: local
