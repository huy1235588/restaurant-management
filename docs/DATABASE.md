# üìä T√†i li·ªáu C∆° s·ªü d·ªØ li·ªáu - H·ªá th·ªëng Qu·∫£n l√Ω Nh√† h√†ng

> T√†i li·ªáu chi ti·∫øt v·ªÅ c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu PostgreSQL cho h·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng

## üìë M·ª•c l·ª•c

- [T·ªïng quan](#-t·ªïng-quan)
- [S∆° ƒë·ªì ERD](#-s∆°-ƒë·ªì-erd)
- [Danh s√°ch B·∫£ng](#-danh-s√°ch-b·∫£ng)
- [Chi ti·∫øt B·∫£ng](#-chi-ti·∫øt-b·∫£ng)
  - [X√°c th·ª±c & Qu·∫£n l√Ω Ng∆∞·ªùi d√πng](#x√°c-th·ª±c--qu·∫£n-l√Ω-ng∆∞·ªùi-d√πng)
  - [Qu·∫£n l√Ω Th·ª±c ƒë∆°n](#qu·∫£n-l√Ω-th·ª±c-ƒë∆°n)
  - [Qu·∫£n l√Ω B√†n](#qu·∫£n-l√Ω-b√†n)
  - [H·ªá th·ªëng ƒê·∫∑t b√†n](#h·ªá-th·ªëng-ƒë·∫∑t-b√†n)
  - [Qu·∫£n l√Ω ƒê∆°n h√†ng](#qu·∫£n-l√Ω-ƒë∆°n-h√†ng)
  - [Qu·∫£n l√Ω B·∫øp](#qu·∫£n-l√Ω-b·∫øp)
  - [Thanh to√°n & H√≥a ƒë∆°n](#thanh-to√°n--h√≥a-ƒë∆°n)
- [C√°c Truy v·∫•n Th∆∞·ªùng d√πng](#-c√°c-truy-v·∫•n-th∆∞·ªùng-d√πng)
- [Chi·∫øn l∆∞·ª£c ƒê√°nh ch·ªâ m·ª•c](#-chi·∫øn-l∆∞·ª£c-ƒë√°nh-ch·ªâ-m·ª•c)
- [M·ªëi quan h·ªá gi·ªØa c√°c B·∫£ng](#-m·ªëi-quan-h·ªá-gi·ªØa-c√°c-b·∫£ng)

---

## üéØ T·ªïng quan

### Gi·ªõi thi·ªáu
H·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng s·ª≠ d·ª•ng PostgreSQL l√†m c∆° s·ªü d·ªØ li·ªáu ch√≠nh v·ªõi Prisma ORM. Database ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ h·ªó tr·ª£:

- ‚úÖ Qu·∫£n l√Ω nh√¢n vi√™n v√† ph√¢n quy·ªÅn
- ‚úÖ Qu·∫£n l√Ω th·ª±c ƒë∆°n v√† danh m·ª•c m√≥n ƒÉn
- ‚úÖ H·ªá th·ªëng ƒë·∫∑t b√†n tr·ª±c tuy·∫øn
- ‚úÖ Qu·∫£n l√Ω ƒë∆°n h√†ng v√† b·∫øp
- ‚úÖ Thanh to√°n v√† h√≥a ƒë∆°n
- ‚úÖ Theo d√µi l·ªãch s·ª≠ giao d·ªãch

### C√¥ng ngh·ªá
- **Database**: PostgreSQL 16+
- **ORM**: Prisma
- **Ki·∫øn tr√∫c**: Relational Database v·ªõi Foreign Keys
- **ƒê·∫∑c ƒëi·ªÉm**: ACID compliance, Transaction support

---

## üìê S∆° ƒë·ªì ERD

```mermaid
erDiagram
    %% Authentication & User Management
    ACCOUNTS ||--o| STAFF : has
    ACCOUNTS ||--o{ REFRESH_TOKENS : has
    
    %% Menu Management
    CATEGORIES ||--o{ MENU_ITEMS : contains
    
    %% Table & Reservation
    RESTAURANT_TABLES ||--o{ RESERVATIONS : books
    RESTAURANT_TABLES ||--o{ ORDERS : serves
    RESTAURANT_TABLES ||--o{ BILLS : generates
    
    %% Reservation & Orders
    RESERVATIONS ||--o{ ORDERS : creates
    
    %% Orders
    ORDERS ||--o{ ORDER_ITEMS : contains
    ORDERS ||--o{ KITCHEN_ORDERS : sends_to
    ORDERS ||--o| BILLS : generates
    STAFF ||--o{ ORDERS : takes
    MENU_ITEMS ||--o{ ORDER_ITEMS : ordered_in
    
    %% Kitchen
    STAFF ||--o{ KITCHEN_ORDERS : assigned_to
    
    %% Billing & Payment
    BILLS ||--o{ BILL_ITEMS : contains
    BILLS ||--o{ PAYMENTS : receives
    STAFF ||--o{ BILLS : processes
    MENU_ITEMS ||--o{ BILL_ITEMS : billed_in
    
    ACCOUNTS {
        int accountId PK
        string username UK
        string email UK
        string phoneNumber UK
        string password
        boolean isActive
        datetime lastLogin
        datetime createdAt
        datetime updatedAt
    }
    
    REFRESH_TOKENS {
        int tokenId PK
        int accountId FK
        string token UK
        datetime expiresAt
        string deviceInfo
        string ipAddress
        boolean isRevoked
        datetime createdAt
        datetime revokedAt
    }
    
    STAFF {
        int staffId PK
        int accountId FK_UK
        string fullName
        string address
        date dateOfBirth
        date hireDate
        decimal salary
        enum role
        boolean isActive
        datetime createdAt
        datetime updatedAt
    }
    
    CATEGORIES {
        int categoryId PK
        string categoryName UK
        string description
        int displayOrder
        boolean isActive
        string imageUrl
        datetime createdAt
        datetime updatedAt
    }
    
    MENU_ITEMS {
        int itemId PK
        string itemCode UK
        string itemName
        int categoryId FK
        decimal price
        decimal cost
        string description
        string imageUrl
        boolean isAvailable
        boolean isActive
        int preparationTime
        int spicyLevel
        boolean isVegetarian
        int calories
        int displayOrder
        datetime createdAt
        datetime updatedAt
    }
    
    RESTAURANT_TABLES {
        int tableId PK
        string tableNumber UK
        string tableName
        int capacity
        int minCapacity
        int floor
        string section
        enum status
        string qrCode UK
        boolean isActive
        datetime createdAt
        datetime updatedAt
    }
    
    RESERVATIONS {
        int reservationId PK
        string reservationCode UK
        string customerName
        string phoneNumber
        string email
        int tableId FK
        date reservationDate
        time reservationTime
        int duration
        int headCount
        string specialRequest
        decimal depositAmount
        enum status
        string notes
        datetime createdAt
        datetime updatedAt
    }
    
    ORDERS {
        int orderId PK
        string orderNumber UK
        int tableId FK
        int staffId FK
        int reservationId FK
        string customerName
        string customerPhone
        int headCount
        enum status
        string notes
        datetime orderTime
        datetime confirmedAt
        datetime completedAt
        datetime createdAt
        datetime updatedAt
    }
    
    ORDER_ITEMS {
        int orderItemId PK
        int orderId FK
        int itemId FK
        int quantity
        decimal unitPrice
        decimal subtotal
        string specialRequest
        enum status
        datetime createdAt
        datetime updatedAt
    }
    
    KITCHEN_ORDERS {
        int kitchenOrderId PK
        int orderId FK
        int staffId FK
        int priority
        enum status
        datetime startedAt
        datetime completedAt
        int estimatedTime
        string notes
        datetime createdAt
        datetime updatedAt
    }
    
    BILLS {
        int billId PK
        string billNumber UK
        int orderId FK_UK
        int tableId FK
        int staffId FK
        decimal subtotal
        decimal taxAmount
        decimal taxRate
        decimal discountAmount
        decimal serviceCharge
        decimal totalAmount
        decimal paidAmount
        decimal changeAmount
        enum paymentStatus
        enum paymentMethod
        string notes
        datetime createdAt
        datetime paidAt
        datetime updatedAt
    }
    
    BILL_ITEMS {
        int billItemId PK
        int billId FK
        int itemId FK
        string itemName
        int quantity
        decimal unitPrice
        decimal subtotal
        decimal discount
        decimal total
        datetime createdAt
    }
    
    PAYMENTS {
        int paymentId PK
        int billId FK
        enum paymentMethod
        decimal amount
        string transactionId
        string cardNumber
        string cardHolderName
        enum status
        string notes
        datetime paymentDate
        datetime createdAt
    }
```

---

## üìã Danh s√°ch B·∫£ng

### B·∫£ng Hi·ªán c√≥ (13 b·∫£ng)

| STT | T√™n B·∫£ng | M·ª•c ƒë√≠ch | S·ªë tr∆∞·ªùng |
|-----|----------|----------|-----------|
| 1 | `accounts` | Qu·∫£n l√Ω t√†i kho·∫£n ƒëƒÉng nh·∫≠p | 9 |
| 2 | `refresh_tokens` | Qu·∫£n l√Ω token l√†m m·ªõi | 9 |
| 3 | `staff` | Th√¥ng tin nh√¢n vi√™n | 11 |
| 4 | `categories` | Danh m·ª•c m√≥n ƒÉn | 8 |
| 5 | `menu_items` | M√≥n ƒÉn trong th·ª±c ƒë∆°n | 17 |
| 6 | `restaurant_tables` | B√†n trong nh√† h√†ng | 12 |
| 7 | `reservations` | ƒê·∫∑t b√†n tr∆∞·ªõc | 15 |
| 8 | `orders` | ƒê∆°n h√†ng | 15 |
| 9 | `order_items` | Chi ti·∫øt ƒë∆°n h√†ng | 9 |
| 10 | `kitchen_orders` | ƒê∆°n h√†ng cho b·∫øp | 10 |
| 11 | `bills` | H√≥a ƒë∆°n thanh to√°n | 17 |
| 12 | `bill_items` | Chi ti·∫øt h√≥a ƒë∆°n | 10 |
| 13 | `payments` | Giao d·ªãch thanh to√°n | 11 |

### C√°c ENUM Types

| T√™n ENUM | Gi√° tr·ªã | M√¥ t·∫£ |
|----------|---------|-------|
| `Role` | admin, manager, waiter, chef, bartender, cashier | Vai tr√≤ nh√¢n vi√™n |
| `TableStatus` | available, occupied, reserved, maintenance | Tr·∫°ng th√°i b√†n |
| `OrderStatus` | pending, confirmed, preparing, ready, served, cancelled | Tr·∫°ng th√°i ƒë∆°n h√†ng |
| `PaymentStatus` | pending, paid, refunded, cancelled | Tr·∫°ng th√°i thanh to√°n |
| `PaymentMethod` | cash, card, momo, bank_transfer | Ph∆∞∆°ng th·ª©c thanh to√°n |
| `ReservationStatus` | pending, confirmed, seated, completed, cancelled, no_show | Tr·∫°ng th√°i ƒë·∫∑t b√†n |

---

## üìù Chi ti·∫øt B·∫£ng

### X√°c th·ª±c & Qu·∫£n l√Ω Ng∆∞·ªùi d√πng

#### 1. B·∫£ng `accounts` (T√†i kho·∫£n)

**M√¥ t·∫£**: L∆∞u tr·ªØ th√¥ng tin t√†i kho·∫£n ƒëƒÉng nh·∫≠p c·ªßa ng∆∞·ªùi d√πng h·ªá th·ªëng

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| accountId | INTEGER | PK, AUTO INCREMENT | ID t√†i kho·∫£n duy nh·∫•t |
| username | VARCHAR(50) | UNIQUE, NOT NULL | T√™n ƒëƒÉng nh·∫≠p |
| email | VARCHAR(255) | UNIQUE, NOT NULL | Email |
| phoneNumber | VARCHAR(20) | UNIQUE, NOT NULL | S·ªë ƒëi·ªán tho·∫°i |
| password | VARCHAR(255) | NOT NULL | M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a |
| isActive | BOOLEAN | DEFAULT true | Tr·∫°ng th√°i k√≠ch ho·∫°t |
| lastLogin | TIMESTAMP | NULLABLE | L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `accountId`
- UNIQUE INDEX: `username`, `email`, `phoneNumber`
- INDEX: `email`, `username`

**Relationships**:
- One-to-One v·ªõi `staff` (1 account ‚Üí 1 staff ho·∫∑c null)
- One-to-Many v·ªõi `refresh_tokens` (1 account ‚Üí nhi·ªÅu tokens)

**V√≠ d·ª• d·ªØ li·ªáu**:
```sql
INSERT INTO accounts (username, email, phoneNumber, password, isActive)
VALUES ('admin01', 'admin@restaurant.com', '0901234567', '$2b$10$...hashed...', true);
```

---

#### 2. B·∫£ng `refresh_tokens` (Token l√†m m·ªõi)

**M√¥ t·∫£**: Qu·∫£n l√Ω refresh tokens cho JWT authentication

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| tokenId | INTEGER | PK, AUTO INCREMENT | ID token |
| accountId | INTEGER | FK, NOT NULL | ID t√†i kho·∫£n |
| token | TEXT | UNIQUE, NOT NULL | Token string |
| expiresAt | TIMESTAMP | NOT NULL | Th·ªùi gian h·∫øt h·∫°n |
| deviceInfo | VARCHAR(500) | NULLABLE | Th√¥ng tin thi·∫øt b·ªã |
| ipAddress | VARCHAR(45) | NULLABLE | ƒê·ªãa ch·ªâ IP |
| isRevoked | BOOLEAN | DEFAULT false | Token ƒë√£ b·ªã thu h·ªìi |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| revokedAt | TIMESTAMP | NULLABLE | Th·ªùi gian thu h·ªìi |

**Indexes**:
- PRIMARY KEY: `tokenId`
- UNIQUE INDEX: `token`
- INDEX: `accountId`, `expiresAt`

**Foreign Keys**:
- `accountId` ‚Üí `accounts(accountId)` ON DELETE CASCADE

---

#### 3. B·∫£ng `staff` (Nh√¢n vi√™n)

**M√¥ t·∫£**: Th√¥ng tin chi ti·∫øt v·ªÅ nh√¢n vi√™n nh√† h√†ng

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| staffId | INTEGER | PK, AUTO INCREMENT | ID nh√¢n vi√™n |
| accountId | INTEGER | FK, UNIQUE, NOT NULL | ID t√†i kho·∫£n li√™n k·∫øt |
| fullName | VARCHAR(255) | NOT NULL | H·ªç t√™n ƒë·∫ßy ƒë·ªß |
| address | VARCHAR(500) | NULLABLE | ƒê·ªãa ch·ªâ |
| dateOfBirth | DATE | NULLABLE | Ng√†y sinh |
| hireDate | DATE | DEFAULT now() | Ng√†y tuy·ªÉn d·ª•ng |
| salary | DECIMAL(12,2) | NULLABLE | L∆∞∆°ng |
| role | ENUM Role | NOT NULL | Vai tr√≤ (admin/manager/waiter/...) |
| isActive | BOOLEAN | DEFAULT true | ƒêang l√†m vi·ªác |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `staffId`
- UNIQUE INDEX: `accountId`
- INDEX: `role`, `isActive`

**Foreign Keys**:
- `accountId` ‚Üí `accounts(accountId)` ON DELETE CASCADE

**Relationships**:
- Many-to-One v·ªõi `accounts`
- One-to-Many v·ªõi `orders`, `bills`, `kitchen_orders`

---

### Qu·∫£n l√Ω Th·ª±c ƒë∆°n

#### 4. B·∫£ng `categories` (Danh m·ª•c m√≥n ƒÉn)

**M√¥ t·∫£**: Ph√¢n lo·∫°i m√≥n ƒÉn theo danh m·ª•c

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| categoryId | INTEGER | PK, AUTO INCREMENT | ID danh m·ª•c |
| categoryName | VARCHAR(100) | UNIQUE, NOT NULL | T√™n danh m·ª•c |
| description | VARCHAR(500) | NULLABLE | M√¥ t·∫£ |
| displayOrder | INTEGER | DEFAULT 0 | Th·ª© t·ª± hi·ªÉn th·ªã |
| isActive | BOOLEAN | DEFAULT true | ƒêang ho·∫°t ƒë·ªông |
| imageUrl | VARCHAR(500) | NULLABLE | URL h√¨nh ·∫£nh |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `categoryId`
- UNIQUE INDEX: `categoryName`
- INDEX: `isActive`

**V√≠ d·ª• d·ªØ li·ªáu**:
```sql
INSERT INTO categories (categoryName, description, displayOrder, isActive)
VALUES 
    ('M√≥n Khai V·ªã', 'C√°c m√≥n ƒÉn khai v·ªã', 1, true),
    ('M√≥n Ch√≠nh', 'M√≥n ƒÉn ch√≠nh', 2, true),
    ('ƒê·ªì U·ªëng', 'N∆∞·ªõc u·ªëng c√°c lo·∫°i', 3, true);
```

---

#### 5. B·∫£ng `menu_items` (M√≥n ƒÉn)

**M√¥ t·∫£**: Chi ti·∫øt th√¥ng tin m√≥n ƒÉn trong th·ª±c ƒë∆°n

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| itemId | INTEGER | PK, AUTO INCREMENT | ID m√≥n ƒÉn |
| itemCode | VARCHAR(20) | UNIQUE, NOT NULL | M√£ m√≥n ƒÉn |
| itemName | VARCHAR(100) | NOT NULL | T√™n m√≥n ƒÉn |
| categoryId | INTEGER | FK, NOT NULL | ID danh m·ª•c |
| price | DECIMAL(10,2) | NOT NULL | Gi√° b√°n |
| cost | DECIMAL(10,2) | NULLABLE | Gi√° v·ªën |
| description | VARCHAR(1000) | NULLABLE | M√¥ t·∫£ m√≥n ƒÉn |
| imageUrl | VARCHAR(500) | NULLABLE | URL h√¨nh ·∫£nh |
| isAvailable | BOOLEAN | DEFAULT true | C√≤n h√†ng |
| isActive | BOOLEAN | DEFAULT true | ƒêang kinh doanh |
| preparationTime | INTEGER | NULLABLE | Th·ªùi gian ch·∫ø bi·∫øn (ph√∫t) |
| spicyLevel | INTEGER | DEFAULT 0 | ƒê·ªô cay (0-5) |
| isVegetarian | BOOLEAN | DEFAULT false | M√≥n chay |
| calories | INTEGER | NULLABLE | L∆∞·ª£ng calo |
| displayOrder | INTEGER | DEFAULT 0 | Th·ª© t·ª± hi·ªÉn th·ªã |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `itemId`
- UNIQUE INDEX: `itemCode`
- INDEX: `categoryId`, `isAvailable`, `isActive`

**Foreign Keys**:
- `categoryId` ‚Üí `categories(categoryId)` ON DELETE RESTRICT

**Business Rules**:
- `spicyLevel`: 0 (kh√¥ng cay) ƒë·∫øn 5 (r·∫•t cay)
- `preparationTime`: t√≠nh b·∫±ng ph√∫t
- `price` ph·∫£i > 0
- `cost` n√™n ‚â§ `price`

---

### Qu·∫£n l√Ω B√†n

#### 6. B·∫£ng `restaurant_tables` (B√†n ƒÉn)

**M√¥ t·∫£**: Qu·∫£n l√Ω b√†n ƒÉn trong nh√† h√†ng

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| tableId | INTEGER | PK, AUTO INCREMENT | ID b√†n |
| tableNumber | VARCHAR(20) | UNIQUE, NOT NULL | S·ªë b√†n |
| tableName | VARCHAR(50) | NULLABLE | T√™n b√†n |
| capacity | INTEGER | NOT NULL | S·ª©c ch·ª©a t·ªëi ƒëa |
| minCapacity | INTEGER | DEFAULT 1 | S·ª©c ch·ª©a t·ªëi thi·ªÉu |
| floor | INTEGER | DEFAULT 1 | T·∫ßng |
| section | VARCHAR(50) | NULLABLE | Khu v·ª±c (VIP, Garden, ...) |
| status | ENUM TableStatus | DEFAULT available | Tr·∫°ng th√°i |
| qrCode | VARCHAR(255) | UNIQUE, NULLABLE | M√£ QR code |
| isActive | BOOLEAN | DEFAULT true | ƒêang ho·∫°t ƒë·ªông |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `tableId`
- UNIQUE INDEX: `tableNumber`, `qrCode`
- INDEX: `status`, `floor`, `isActive`

**Enum Values**:
- `TableStatus`: available, occupied, reserved, maintenance

**Business Rules**:
- `capacity` > 0
- `minCapacity` ‚â§ `capacity`
- `floor` ‚â• 1

---

### H·ªá th·ªëng ƒê·∫∑t b√†n

#### 7. B·∫£ng `reservations` (ƒê·∫∑t b√†n)

**M√¥ t·∫£**: Qu·∫£n l√Ω ƒë·∫∑t b√†n tr∆∞·ªõc c·ªßa kh√°ch h√†ng

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| reservationId | INTEGER | PK, AUTO INCREMENT | ID ƒë·∫∑t b√†n |
| reservationCode | VARCHAR(50) | UNIQUE, DEFAULT uuid() | M√£ ƒë·∫∑t b√†n |
| customerName | VARCHAR(255) | NOT NULL | T√™n kh√°ch h√†ng |
| phoneNumber | VARCHAR(20) | NOT NULL | S·ªë ƒëi·ªán tho·∫°i |
| email | VARCHAR(255) | NULLABLE | Email |
| tableId | INTEGER | FK, NOT NULL | ID b√†n |
| reservationDate | DATE | NOT NULL | Ng√†y ƒë·∫∑t |
| reservationTime | TIME | NOT NULL | Gi·ªù ƒë·∫∑t |
| duration | INTEGER | DEFAULT 120 | Th·ªùi gian (ph√∫t) |
| headCount | INTEGER | NOT NULL | S·ªë ng∆∞·ªùi |
| specialRequest | TEXT | NULLABLE | Y√™u c·∫ßu ƒë·∫∑c bi·ªát |
| depositAmount | DECIMAL(10,2) | NULLABLE | Ti·ªÅn ƒë·∫∑t c·ªçc |
| status | ENUM ReservationStatus | DEFAULT pending | Tr·∫°ng th√°i |
| notes | TEXT | NULLABLE | Ghi ch√∫ |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `reservationId`
- UNIQUE INDEX: `reservationCode`
- INDEX: `reservationDate`, `status`, `phoneNumber`, `tableId`

**Foreign Keys**:
- `tableId` ‚Üí `restaurant_tables(tableId)` ON DELETE RESTRICT

**Enum Values**:
- `ReservationStatus`: pending, confirmed, seated, completed, cancelled, no_show

**Business Rules**:
- `duration` m·∫∑c ƒë·ªãnh 120 ph√∫t (2 gi·ªù)
- `headCount` ph·∫£i ph√π h·ª£p v·ªõi `capacity` c·ªßa b√†n
- `reservationDate` + `reservationTime` ph·∫£i trong t∆∞∆°ng lai

**Workflow**:
1. **pending**: Kh√°ch ƒë·∫∑t b√†n, ch·ªù x√°c nh·∫≠n
2. **confirmed**: Nh√† h√†ng x√°c nh·∫≠n
3. **seated**: Kh√°ch ƒë√£ ƒë·∫øn v√† ng·ªìi
4. **completed**: Ho√†n th√†nh
5. **cancelled**: Kh√°ch h·ªßy
6. **no_show**: Kh√°ch kh√¥ng ƒë·∫øn

---

### Qu·∫£n l√Ω ƒê∆°n h√†ng

#### 8. B·∫£ng `orders` (ƒê∆°n h√†ng)

**M√¥ t·∫£**: Qu·∫£n l√Ω ƒë∆°n g·ªçi m√≥n c·ªßa kh√°ch h√†ng

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| orderId | INTEGER | PK, AUTO INCREMENT | ID ƒë∆°n h√†ng |
| orderNumber | VARCHAR(50) | UNIQUE, DEFAULT uuid() | S·ªë ƒë∆°n h√†ng |
| tableId | INTEGER | FK, NOT NULL | ID b√†n |
| staffId | INTEGER | FK, NULLABLE | ID nh√¢n vi√™n ph·ª•c v·ª• |
| reservationId | INTEGER | FK, NULLABLE | ID ƒë·∫∑t b√†n (n·∫øu c√≥) |
| customerName | VARCHAR(255) | NULLABLE | T√™n kh√°ch h√†ng |
| customerPhone | VARCHAR(20) | NULLABLE | SƒêT kh√°ch h√†ng |
| headCount | INTEGER | DEFAULT 1 | S·ªë ng∆∞·ªùi |
| status | ENUM OrderStatus | DEFAULT pending | Tr·∫°ng th√°i |
| notes | TEXT | NULLABLE | Ghi ch√∫ |
| orderTime | TIMESTAMP | DEFAULT now() | Th·ªùi gian ƒë·∫∑t |
| confirmedAt | TIMESTAMP | NULLABLE | Th·ªùi gian x√°c nh·∫≠n |
| completedAt | TIMESTAMP | NULLABLE | Th·ªùi gian ho√†n th√†nh |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `orderId`
- UNIQUE INDEX: `orderNumber`
- INDEX: `tableId`, `status`, `orderTime`

**Foreign Keys**:
- `tableId` ‚Üí `restaurant_tables(tableId)` ON DELETE RESTRICT
- `staffId` ‚Üí `staff(staffId)` ON DELETE SET NULL
- `reservationId` ‚Üí `reservations(reservationId)` ON DELETE SET NULL

**Enum Values**:
- `OrderStatus`: pending, confirmed, preparing, ready, served, cancelled

---

#### 9. B·∫£ng `order_items` (Chi ti·∫øt ƒë∆°n h√†ng)

**M√¥ t·∫£**: L∆∞u chi ti·∫øt m√≥n ƒÉn trong ƒë∆°n h√†ng

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| orderItemId | INTEGER | PK, AUTO INCREMENT | ID chi ti·∫øt |
| orderId | INTEGER | FK, NOT NULL | ID ƒë∆°n h√†ng |
| itemId | INTEGER | FK, NOT NULL | ID m√≥n ƒÉn |
| quantity | INTEGER | NOT NULL | S·ªë l∆∞·ª£ng |
| unitPrice | DECIMAL(10,2) | NOT NULL | ƒê∆°n gi√° |
| subtotal | DECIMAL(10,2) | NOT NULL | Th√†nh ti·ªÅn |
| specialRequest | VARCHAR(500) | NULLABLE | Y√™u c·∫ßu ƒë·∫∑c bi·ªát |
| status | ENUM OrderStatus | DEFAULT pending | Tr·∫°ng th√°i |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `orderItemId`
- INDEX: `orderId`, `itemId`, `status`

**Foreign Keys**:
- `orderId` ‚Üí `orders(orderId)` ON DELETE CASCADE
- `itemId` ‚Üí `menu_items(itemId)` ON DELETE RESTRICT

**Business Rules**:
- `quantity` > 0
- `subtotal` = `quantity` √ó `unitPrice`

---

### Qu·∫£n l√Ω B·∫øp

#### 10. B·∫£ng `kitchen_orders` (ƒê∆°n b·∫øp)

**M√¥ t·∫£**: Qu·∫£n l√Ω ƒë∆°n h√†ng g·ª≠i cho b·∫øp

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| kitchenOrderId | INTEGER | PK, AUTO INCREMENT | ID ƒë∆°n b·∫øp |
| orderId | INTEGER | FK, NOT NULL | ID ƒë∆°n h√†ng |
| staffId | INTEGER | FK, NULLABLE | ID ƒë·∫ßu b·∫øp |
| priority | INTEGER | DEFAULT 0 | ƒê·ªô ∆∞u ti√™n |
| status | ENUM OrderStatus | DEFAULT pending | Tr·∫°ng th√°i |
| startedAt | TIMESTAMP | NULLABLE | Th·ªùi gian b·∫Øt ƒë·∫ßu |
| completedAt | TIMESTAMP | NULLABLE | Th·ªùi gian ho√†n th√†nh |
| estimatedTime | INTEGER | NULLABLE | Th·ªùi gian ∆∞·ªõc t√≠nh (ph√∫t) |
| notes | TEXT | NULLABLE | Ghi ch√∫ |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `kitchenOrderId`
- INDEX: `orderId`, `status`, `priority`

**Foreign Keys**:
- `orderId` ‚Üí `orders(orderId)` ON DELETE CASCADE
- `staffId` ‚Üí `staff(staffId)` ON DELETE SET NULL

**Business Rules**:
- `priority`: s·ªë c√†ng l·ªõn, ƒë·ªô ∆∞u ti√™n c√†ng cao
- `estimatedTime`: t√≠nh b·∫±ng ph√∫t

---

### Thanh to√°n & H√≥a ƒë∆°n

#### 11. B·∫£ng `bills` (H√≥a ƒë∆°n)

**M√¥ t·∫£**: Qu·∫£n l√Ω h√≥a ƒë∆°n thanh to√°n

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| billId | INTEGER | PK, AUTO INCREMENT | ID h√≥a ƒë∆°n |
| billNumber | VARCHAR(50) | UNIQUE, DEFAULT uuid() | S·ªë h√≥a ƒë∆°n |
| orderId | INTEGER | FK, UNIQUE, NOT NULL | ID ƒë∆°n h√†ng |
| tableId | INTEGER | FK, NOT NULL | ID b√†n |
| staffId | INTEGER | FK, NULLABLE | ID thu ng√¢n |
| subtotal | DECIMAL(12,2) | NOT NULL | T·ªïng ti·ªÅn h√†ng |
| taxAmount | DECIMAL(12,2) | DEFAULT 0 | Ti·ªÅn thu·∫ø |
| taxRate | DECIMAL(5,2) | DEFAULT 0 | T·ª∑ l·ªá thu·∫ø (%) |
| discountAmount | DECIMAL(12,2) | DEFAULT 0 | Ti·ªÅn gi·∫£m gi√° |
| serviceCharge | DECIMAL(12,2) | DEFAULT 0 | Ph√≠ d·ªãch v·ª• |
| totalAmount | DECIMAL(12,2) | NOT NULL | T·ªïng c·ªông |
| paidAmount | DECIMAL(12,2) | DEFAULT 0 | Ti·ªÅn ƒë√£ tr·∫£ |
| changeAmount | DECIMAL(12,2) | DEFAULT 0 | Ti·ªÅn th·ªëi l·∫°i |
| paymentStatus | ENUM PaymentStatus | DEFAULT pending | Tr·∫°ng th√°i |
| paymentMethod | ENUM PaymentMethod | NULLABLE | Ph∆∞∆°ng th·ª©c |
| notes | TEXT | NULLABLE | Ghi ch√∫ |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |
| paidAt | TIMESTAMP | NULLABLE | Th·ªùi gian thanh to√°n |
| updatedAt | TIMESTAMP | AUTO UPDATE | Th·ªùi gian c·∫≠p nh·∫≠t |

**Indexes**:
- PRIMARY KEY: `billId`
- UNIQUE INDEX: `billNumber`, `orderId`
- INDEX: `paymentStatus`, `createdAt`

**Foreign Keys**:
- `orderId` ‚Üí `orders(orderId)` ON DELETE RESTRICT
- `tableId` ‚Üí `restaurant_tables(tableId)` ON DELETE RESTRICT
- `staffId` ‚Üí `staff(staffId)` ON DELETE SET NULL

**Enum Values**:
- `PaymentStatus`: pending, paid, refunded, cancelled
- `PaymentMethod`: cash, card, momo, bank_transfer

**Business Rules**:
- `totalAmount` = `subtotal` + `taxAmount` + `serviceCharge` - `discountAmount`
- `changeAmount` = `paidAmount` - `totalAmount` (n·∫øu `paidAmount` > `totalAmount`)

---

#### 12. B·∫£ng `bill_items` (Chi ti·∫øt h√≥a ƒë∆°n)

**M√¥ t·∫£**: Chi ti·∫øt m√≥n ƒÉn trong h√≥a ƒë∆°n

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| billItemId | INTEGER | PK, AUTO INCREMENT | ID chi ti·∫øt |
| billId | INTEGER | FK, NOT NULL | ID h√≥a ƒë∆°n |
| itemId | INTEGER | FK, NOT NULL | ID m√≥n ƒÉn |
| itemName | VARCHAR(100) | NOT NULL | T√™n m√≥n (snapshot) |
| quantity | INTEGER | NOT NULL | S·ªë l∆∞·ª£ng |
| unitPrice | DECIMAL(10,2) | NOT NULL | ƒê∆°n gi√° |
| subtotal | DECIMAL(10,2) | NOT NULL | T·∫°m t√≠nh |
| discount | DECIMAL(10,2) | DEFAULT 0 | Gi·∫£m gi√° |
| total | DECIMAL(10,2) | NOT NULL | Th√†nh ti·ªÅn |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |

**Indexes**:
- PRIMARY KEY: `billItemId`
- INDEX: `billId`

**Foreign Keys**:
- `billId` ‚Üí `bills(billId)` ON DELETE CASCADE
- `itemId` ‚Üí `menu_items(itemId)` ON DELETE RESTRICT

**Business Rules**:
- `total` = `subtotal` - `discount`
- `subtotal` = `quantity` √ó `unitPrice`

---

#### 13. B·∫£ng `payments` (Thanh to√°n)

**M√¥ t·∫£**: Ghi nh·∫≠n c√°c giao d·ªãch thanh to√°n

**C·∫•u tr√∫c**:

| Tr∆∞·ªùng | Ki·ªÉu | R√†ng bu·ªôc | M√¥ t·∫£ |
|--------|------|-----------|-------|
| paymentId | INTEGER | PK, AUTO INCREMENT | ID thanh to√°n |
| billId | INTEGER | FK, NOT NULL | ID h√≥a ƒë∆°n |
| paymentMethod | ENUM PaymentMethod | NOT NULL | Ph∆∞∆°ng th·ª©c |
| amount | DECIMAL(12,2) | NOT NULL | S·ªë ti·ªÅn |
| transactionId | VARCHAR(100) | NULLABLE | M√£ giao d·ªãch |
| cardNumber | VARCHAR(20) | NULLABLE | S·ªë th·∫ª (4 s·ªë cu·ªëi) |
| cardHolderName | VARCHAR(255) | NULLABLE | T√™n ch·ªß th·∫ª |
| status | ENUM PaymentStatus | DEFAULT pending | Tr·∫°ng th√°i |
| notes | TEXT | NULLABLE | Ghi ch√∫ |
| paymentDate | TIMESTAMP | DEFAULT now() | Ng√†y thanh to√°n |
| createdAt | TIMESTAMP | DEFAULT now() | Th·ªùi gian t·∫°o |

**Indexes**:
- PRIMARY KEY: `paymentId`
- INDEX: `billId`, `transactionId`

**Foreign Keys**:
- `billId` ‚Üí `bills(billId)` ON DELETE CASCADE

**Security Notes**:
- Ch·ªâ l∆∞u 4 s·ªë cu·ªëi c·ªßa th·∫ª
- Kh√¥ng l∆∞u CVV ho·∫∑c PIN
- M√£ h√≥a `transactionId`

---

## üîç C√°c Truy v·∫•n Th∆∞·ªùng d√πng

### 1. Truy v·∫•n ƒê∆°n h√†ng

#### L·∫•y danh s√°ch ƒë∆°n h√†ng ƒëang ho·∫°t ƒë·ªông
```sql
SELECT 
    o.orderId,
    o.orderNumber,
    t.tableNumber,
    s.fullName AS waiterName,
    o.headCount,
    o.status,
    o.orderTime,
    COUNT(oi.orderItemId) AS totalItems
FROM orders o
INNER JOIN restaurant_tables t ON o.tableId = t.tableId
LEFT JOIN staff s ON o.staffId = s.staffId
LEFT JOIN order_items oi ON o.orderId = oi.orderId
WHERE o.status IN ('pending', 'confirmed', 'preparing', 'ready')
GROUP BY o.orderId, t.tableNumber, s.fullName
ORDER BY o.orderTime DESC;
```

#### Chi ti·∫øt ƒë∆°n h√†ng v·ªõi m√≥n ƒÉn
```sql
SELECT 
    o.orderNumber,
    o.orderTime,
    t.tableNumber,
    mi.itemName,
    oi.quantity,
    oi.unitPrice,
    oi.subtotal,
    oi.specialRequest,
    oi.status
FROM orders o
INNER JOIN order_items oi ON o.orderId = oi.orderId
INNER JOIN menu_items mi ON oi.itemId = mi.itemId
INNER JOIN restaurant_tables t ON o.tableId = t.tableId
WHERE o.orderNumber = 'ORDER-12345'
ORDER BY oi.createdAt;
```

### 2. Truy v·∫•n B√†n & ƒê·∫∑t b√†n

#### Ki·ªÉm tra b√†n tr·ªëng
```sql
SELECT 
    tableId,
    tableNumber,
    tableName,
    capacity,
    floor,
    section,
    status
FROM restaurant_tables
WHERE status = 'available'
    AND isActive = true
    AND capacity >= 4  -- S·ªë ng∆∞·ªùi c·∫ßn
ORDER BY floor, tableNumber;
```

#### L·∫•y l·ªãch ƒë·∫∑t b√†n theo ng√†y
```sql
SELECT 
    r.reservationCode,
    r.customerName,
    r.phoneNumber,
    t.tableNumber,
    r.reservationDate,
    r.reservationTime,
    r.duration,
    r.headCount,
    r.status,
    r.specialRequest
FROM reservations r
INNER JOIN restaurant_tables t ON r.tableId = t.tableId
WHERE r.reservationDate = '2025-10-20'
    AND r.status IN ('confirmed', 'pending')
ORDER BY r.reservationTime;
```

#### Ki·ªÉm tra b√†n c√≥ tr·ªëng kh√¥ng (theo th·ªùi gian)
```sql
SELECT tableId, tableNumber
FROM restaurant_tables t
WHERE t.isActive = true
    AND t.capacity >= 4
    AND NOT EXISTS (
        SELECT 1 
        FROM reservations r
        WHERE r.tableId = t.tableId
            AND r.reservationDate = '2025-10-20'
            AND r.status IN ('confirmed', 'seated')
            AND '18:00:00' BETWEEN r.reservationTime 
                AND (r.reservationTime + (r.duration || ' minutes')::INTERVAL)
    );
```

### 3. Truy v·∫•n H√≥a ƒë∆°n & Doanh thu

#### Doanh thu theo ng√†y
```sql
SELECT 
    DATE(createdAt) AS date,
    COUNT(*) AS totalBills,
    SUM(subtotal) AS subtotal,
    SUM(taxAmount) AS taxAmount,
    SUM(discountAmount) AS discountAmount,
    SUM(totalAmount) AS totalRevenue
FROM bills
WHERE paymentStatus = 'paid'
    AND createdAt >= '2025-10-01'
    AND createdAt < '2025-11-01'
GROUP BY DATE(createdAt)
ORDER BY date DESC;
```

#### Top m√≥n b√°n ch·∫°y
```sql
SELECT 
    mi.itemName,
    mi.itemCode,
    c.categoryName,
    COUNT(bi.billItemId) AS orderCount,
    SUM(bi.quantity) AS totalQuantity,
    SUM(bi.total) AS totalRevenue
FROM bill_items bi
INNER JOIN menu_items mi ON bi.itemId = mi.itemId
INNER JOIN categories c ON mi.categoryId = c.categoryId
INNER JOIN bills b ON bi.billId = b.billId
WHERE b.paymentStatus = 'paid'
    AND b.createdAt >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY mi.itemId, mi.itemName, mi.itemCode, c.categoryName
ORDER BY totalQuantity DESC
LIMIT 10;
```

#### Chi ti·∫øt h√≥a ƒë∆°n
```sql
SELECT 
    b.billNumber,
    b.createdAt AS billDate,
    t.tableNumber,
    s.fullName AS cashierName,
    bi.itemName,
    bi.quantity,
    bi.unitPrice,
    bi.discount,
    bi.total,
    b.subtotal,
    b.taxAmount,
    b.discountAmount,
    b.serviceCharge,
    b.totalAmount,
    b.paymentMethod,
    b.paymentStatus
FROM bills b
INNER JOIN bill_items bi ON b.billId = bi.billId
INNER JOIN restaurant_tables t ON b.tableId = t.tableId
LEFT JOIN staff s ON b.staffId = s.staffId
WHERE b.billNumber = 'BILL-12345'
ORDER BY bi.billItemId;
```

### 4. Truy v·∫•n Nh√¢n vi√™n

#### Hi·ªáu su·∫•t nh√¢n vi√™n ph·ª•c v·ª•
```sql
SELECT 
    s.staffId,
    s.fullName,
    s.role,
    COUNT(DISTINCT o.orderId) AS totalOrders,
    COUNT(DISTINCT b.billId) AS totalBills,
    SUM(b.totalAmount) AS totalRevenue,
    AVG(b.totalAmount) AS avgBillAmount
FROM staff s
LEFT JOIN orders o ON s.staffId = o.staffId
LEFT JOIN bills b ON o.orderId = b.orderId
WHERE s.role IN ('waiter', 'manager')
    AND s.isActive = true
    AND b.paymentStatus = 'paid'
    AND b.createdAt >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY s.staffId, s.fullName, s.role
ORDER BY totalRevenue DESC;
```

### 5. Truy v·∫•n Th·ª±c ƒë∆°n

#### M√≥n ƒÉn theo danh m·ª•c (c√≥ s·∫µn)
```sql
SELECT 
    c.categoryName,
    c.displayOrder AS categoryOrder,
    mi.itemCode,
    mi.itemName,
    mi.price,
    mi.description,
    mi.preparationTime,
    mi.spicyLevel,
    mi.isVegetarian,
    mi.imageUrl
FROM menu_items mi
INNER JOIN categories c ON mi.categoryId = c.categoryId
WHERE mi.isActive = true
    AND mi.isAvailable = true
    AND c.isActive = true
ORDER BY c.displayOrder, mi.displayOrder, mi.itemName;
```

#### Ph√¢n t√≠ch gi√° v·ªën - gi√° b√°n
```sql
SELECT 
    mi.itemCode,
    mi.itemName,
    mi.cost,
    mi.price,
    (mi.price - mi.cost) AS profit,
    ROUND((mi.price - mi.cost) / mi.price * 100, 2) AS profitMargin
FROM menu_items mi
WHERE mi.cost IS NOT NULL
    AND mi.isActive = true
ORDER BY profitMargin DESC;
```

### 6. Truy v·∫•n B·∫øp

#### Danh s√°ch ƒë∆°n b·∫øp ƒëang ch·ªù
```sql
SELECT 
    ko.kitchenOrderId,
    ko.priority,
    o.orderNumber,
    t.tableNumber,
    ko.status,
    ko.estimatedTime,
    ko.createdAt,
    COUNT(oi.orderItemId) AS totalItems,
    s.fullName AS chefName
FROM kitchen_orders ko
INNER JOIN orders o ON ko.orderId = o.orderId
INNER JOIN restaurant_tables t ON o.tableId = t.tableId
LEFT JOIN order_items oi ON o.orderId = oi.orderId
LEFT JOIN staff s ON ko.staffId = s.staffId
WHERE ko.status IN ('pending', 'preparing')
GROUP BY ko.kitchenOrderId, o.orderNumber, t.tableNumber, s.fullName
ORDER BY ko.priority DESC, ko.createdAt;
```

#### Th·ªùi gian ch·∫ø bi·∫øn trung b√¨nh
```sql
SELECT 
    DATE(ko.createdAt) AS date,
    AVG(EXTRACT(EPOCH FROM (ko.completedAt - ko.startedAt))/60) AS avgPrepTimeMinutes,
    COUNT(*) AS totalOrders
FROM kitchen_orders ko
WHERE ko.status = 'ready'
    AND ko.startedAt IS NOT NULL
    AND ko.completedAt IS NOT NULL
    AND ko.createdAt >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY DATE(ko.createdAt)
ORDER BY date DESC;
```

---

## üìä Chi·∫øn l∆∞·ª£c ƒê√°nh ch·ªâ m·ª•c

### Indexes Hi·ªán c√≥

#### B·∫£ng accounts
- `PRIMARY KEY (accountId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (username, email, phoneNumber)` - ƒê·∫£m b·∫£o unique
- `INDEX (email)` - T√¨m ki·∫øm login
- `INDEX (username)` - T√¨m ki·∫øm login

#### B·∫£ng refresh_tokens
- `PRIMARY KEY (tokenId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (token)` - Validate token
- `INDEX (accountId)` - T√¨m tokens c·ªßa user
- `INDEX (expiresAt)` - X√≥a tokens h·∫øt h·∫°n

#### B·∫£ng staff
- `PRIMARY KEY (staffId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (accountId)` - 1-1 relationship
- `INDEX (role)` - L·ªçc theo vai tr√≤
- `INDEX (isActive)` - L·ªçc nh√¢n vi√™n active

#### B·∫£ng categories
- `PRIMARY KEY (categoryId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (categoryName)` - ƒê·∫£m b·∫£o unique
- `INDEX (isActive)` - L·ªçc danh m·ª•c active

#### B·∫£ng menu_items
- `PRIMARY KEY (itemId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (itemCode)` - ƒê·∫£m b·∫£o unique
- `INDEX (categoryId)` - Join v·ªõi categories
- `INDEX (isAvailable)` - L·ªçc m√≥n c√≤n h√†ng
- `INDEX (isActive)` - L·ªçc m√≥n ƒëang b√°n

#### B·∫£ng restaurant_tables
- `PRIMARY KEY (tableId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (tableNumber, qrCode)` - ƒê·∫£m b·∫£o unique
- `INDEX (status)` - T√¨m b√†n tr·ªëng
- `INDEX (floor)` - L·ªçc theo t·∫ßng
- `INDEX (isActive)` - L·ªçc b√†n active

#### B·∫£ng reservations
- `PRIMARY KEY (reservationId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (reservationCode)` - Tracking
- `INDEX (reservationDate)` - L·ªçc theo ng√†y
- `INDEX (status)` - L·ªçc theo tr·∫°ng th√°i
- `INDEX (phoneNumber)` - T√¨m theo SƒêT
- `INDEX (tableId)` - Join v·ªõi tables

#### B·∫£ng orders
- `PRIMARY KEY (orderId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (orderNumber)` - Tracking
- `INDEX (tableId)` - Join v·ªõi tables
- `INDEX (status)` - L·ªçc theo tr·∫°ng th√°i
- `INDEX (orderTime)` - S·∫Øp x·∫øp theo th·ªùi gian

#### B·∫£ng order_items
- `PRIMARY KEY (orderItemId)` - T√¨m ki·∫øm theo ID
- `INDEX (orderId)` - Join v·ªõi orders
- `INDEX (itemId)` - Join v·ªõi menu_items
- `INDEX (status)` - L·ªçc theo tr·∫°ng th√°i

#### B·∫£ng kitchen_orders
- `PRIMARY KEY (kitchenOrderId)` - T√¨m ki·∫øm theo ID
- `INDEX (orderId)` - Join v·ªõi orders
- `INDEX (status)` - L·ªçc theo tr·∫°ng th√°i
- `INDEX (priority)` - S·∫Øp x·∫øp ∆∞u ti√™n

#### B·∫£ng bills
- `PRIMARY KEY (billId)` - T√¨m ki·∫øm theo ID
- `UNIQUE (billNumber, orderId)` - Tracking & 1-1
- `INDEX (paymentStatus)` - L·ªçc theo tr·∫°ng th√°i
- `INDEX (createdAt)` - B√°o c√°o doanh thu

#### B·∫£ng bill_items
- `PRIMARY KEY (billItemId)` - T√¨m ki·∫øm theo ID
- `INDEX (billId)` - Join v·ªõi bills

#### B·∫£ng payments
- `PRIMARY KEY (paymentId)` - T√¨m ki·∫øm theo ID
- `INDEX (billId)` - Join v·ªõi bills
- `INDEX (transactionId)` - Tracking giao d·ªãch

### L·ª£i √≠ch Indexing

1. **T√¨m ki·∫øm nhanh**: PRIMARY KEY v√† UNIQUE indexes
2. **Join hi·ªáu qu·∫£**: Foreign key indexes
3. **L·ªçc d·ªØ li·ªáu**: Status, date indexes
4. **B√°o c√°o**: Date range queries
5. **X√≥a d·ªØ li·ªáu**: Expired tokens cleanup

### Maintenance Tips

```sql
-- Ph√¢n t√≠ch v√† t·ªëi ∆∞u indexes
ANALYZE menu_items;
REINDEX TABLE orders;

-- Ki·ªÉm tra index usage
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC;

-- T√¨m indexes kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng
SELECT 
    schemaname,
    tablename,
    indexname
FROM pg_stat_user_indexes
WHERE idx_scan = 0
    AND indexname NOT LIKE '%_pkey';
```

---

## üîó M·ªëi quan h·ªá gi·ªØa c√°c B·∫£ng

### Relationships Map

#### 1. Authentication Flow
```
accounts (1) ‚Üê‚Üí (1) staff
accounts (1) ‚Üí (N) refresh_tokens
```

#### 2. Menu Structure
```
categories (1) ‚Üí (N) menu_items
```

#### 3. Table & Reservation
```
restaurant_tables (1) ‚Üí (N) reservations
restaurant_tables (1) ‚Üí (N) orders
restaurant_tables (1) ‚Üí (N) bills
```

#### 4. Order Flow
```
reservations (1) ‚Üí (N) orders
orders (1) ‚Üí (N) order_items
orders (1) ‚Üí (N) kitchen_orders
orders (1) ‚Üí (1) bills
staff (1) ‚Üí (N) orders (waiter)
menu_items (1) ‚Üí (N) order_items
```

#### 5. Kitchen Flow
```
orders (1) ‚Üí (N) kitchen_orders
staff (1) ‚Üí (N) kitchen_orders (chef)
```

#### 6. Billing Flow
```
bills (1) ‚Üí (N) bill_items
bills (1) ‚Üí (N) payments
staff (1) ‚Üí (N) bills (cashier)
menu_items (1) ‚Üí (N) bill_items
```

### Cascade Rules

| Relationship | ON DELETE |
|--------------|-----------|
| account ‚Üí staff | CASCADE |
| account ‚Üí refresh_tokens | CASCADE |
| order ‚Üí order_items | CASCADE |
| order ‚Üí kitchen_orders | CASCADE |
| bill ‚Üí bill_items | CASCADE |
| bill ‚Üí payments | CASCADE |
| category ‚Üí menu_items | RESTRICT |
| table ‚Üí reservations | RESTRICT |
| table ‚Üí orders | RESTRICT |
| table ‚Üí bills | RESTRICT |
| staff ‚Üí orders | SET NULL |
| staff ‚Üí bills | SET NULL |

---

## üìà T·ªëi ∆∞u h√≥a & Best Practices

### 1. Performance Tips

- S·ª≠ d·ª•ng connection pooling
- Batch insert cho nhi·ªÅu records
- Pagination cho danh s√°ch l·ªõn
- Cache c√°c truy v·∫•n th∆∞·ªùng d√πng
- S·ª≠ d·ª•ng prepared statements

### 2. Data Integrity

- Foreign keys ƒë·∫£m b·∫£o referential integrity
- UNIQUE constraints ngƒÉn duplicate
- CHECK constraints validate business rules
- NOT NULL cho required fields
- Default values h·ª£p l√Ω

### 3. Security

- Hash passwords v·ªõi bcrypt
- Kh√¥ng l∆∞u th√¥ng tin th·∫ª ƒë·∫ßy ƒë·ªß
- Encrypt sensitive data
- Audit logs cho c√°c thao t√°c quan tr·ªçng
- Row-level security n·∫øu c·∫ßn

### 4. Backup Strategy

```bash
# Daily backup
pg_dump -U postgres -d restaurant_db > backup_$(date +%Y%m%d).sql

# Restore
psql -U postgres -d restaurant_db < backup_20251020.sql
```

### 5. Monitoring Queries

```sql
-- Slow queries
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- Database size
SELECT 
    pg_size_pretty(pg_database_size('restaurant_db')) AS db_size;

-- Table sizes
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## üöÄ Migration & Setup

### Prisma Commands

```bash
# Generate Prisma Client
pnpm prisma generate

# Run migrations
pnpm prisma migrate deploy

# Create new migration
pnpm prisma migrate dev --name add_new_feature

# Reset database (development only)
pnpm prisma migrate reset

# Seed database
pnpm prisma db seed

# Open Prisma Studio
pnpm prisma studio
```

### Environment Setup

```env
DATABASE_URL="postgresql://user:password@localhost:5432/restaurant_db?schema=public"
```

---

## üìù Ghi ch√∫

### Future Enhancements

C√°c b·∫£ng c√≥ th·ªÉ b·ªï sung trong t∆∞∆°ng lai theo y√™u c·∫ßu t·ª´ issue:

#### Qu·∫£n l√Ω T·ªìn kho
- `ingredients` - Nguy√™n li·ªáu
- `suppliers` - Nh√† cung c·∫•p
- `recipe` - C√¥ng th·ª©c m√≥n ƒÉn
- `stock_transactions` - Giao d·ªãch t·ªìn kho
- `purchase_orders` - ƒê∆°n ƒë·∫∑t h√†ng
- `purchase_order_items` - Chi ti·∫øt ƒë∆°n ƒë·∫∑t h√†ng
- `ingredient_batches` - L√¥ nguy√™n li·ªáu
- `stock_alerts` - C·∫£nh b√°o t·ªìn kho

#### ƒê·∫∑t b√†n n√¢ng cao
- `reservation_history` - L·ªãch s·ª≠ ƒë·∫∑t b√†n
- `table_availability` - L·ªãch tr·ªëng b√†n
- `reservation_notifications` - Th√¥ng b√°o ƒë·∫∑t b√†n

#### Kh√°c
- `customers` - Kh√°ch h√†ng th∆∞·ªùng xuy√™n
- `promotions` - Ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i
- `loyalty_points` - ƒêi·ªÉm th∆∞·ªüng
- `reviews` - ƒê√°nh gi√° m√≥n ƒÉn

### Version History

- **v1.0** - Initial schema (2025-10-14)
  - Core tables: accounts, staff, menu, tables, orders, bills
  - Reservation system
  - Kitchen management
  - Payment processing

---

## üìû Li√™n h·ªá & H·ªó tr·ª£

- **Repository**: https://github.com/huy1235588/restaurant-management
- **Documentation**: `/docs` folder
- **Issues**: GitHub Issues

---

**T√†i li·ªáu ƒë∆∞·ª£c t·∫°o b·ªüi**: @huy1235588
**C·∫≠p nh·∫≠t l·∫ßn cu·ªëi**: 2025-10-19
