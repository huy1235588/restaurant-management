name: Deploy to DigitalOcean VPS

on:
  # Tá»± Ä‘á»™ng deploy khi push vÃ o main
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'deploy/**'
      - '.github/workflows/deploy-digitalocean.yml'
  
  # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Skip pre-deployment backup'
        required: false
        default: false
        type: boolean
      no_build:
        description: 'Skip Docker image rebuild'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  APP_DIR: /opt/restaurant-management
  DEPLOY_USER: root
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Build vÃ  push Docker images lÃªn GitHub Container Registry
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      client_image: ${{ steps.get-client-tag.outputs.tag }}
      server_image: ${{ steps.get-server-tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Client
        id: meta-client
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/client
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Client image
        uses: docker/build-push-action@v5
        with:
          context: ./app/client
          file: ./app/client/Dockerfile
          push: true
          tags: ${{ steps.meta-client.outputs.tags }}
          labels: ${{ steps.meta-client.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}
            NEXT_PUBLIC_STORAGE_URL=${{ secrets.NEXT_PUBLIC_STORAGE_URL }}
            GITHUB_SHA=${{ github.sha }}
          no-cache: true

      - name: Get Client image tag
        id: get-client-tag
        run: |
          TAGS="${{ steps.meta-client.outputs.tags }}"
          FIRST_TAG=$(echo "$TAGS" | head -n1)
          echo "tag=$FIRST_TAG" >> $GITHUB_OUTPUT
          echo "Selected client tag: $FIRST_TAG"

      - name: Extract metadata for Server
        id: meta-server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/server
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Server image
        uses: docker/build-push-action@v5
        with:
          context: ./app/server
          file: ./app/server/Dockerfile
          push: true
          tags: ${{ steps.meta-server.outputs.tags }}
          labels: ${{ steps.meta-server.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
          no-cache: true

      - name: Get Server image tag
        id: get-server-tag
        run: |
          TAGS="${{ steps.meta-server.outputs.tags }}"
          FIRST_TAG=$(echo "$TAGS" | head -n1)
          echo "tag=$FIRST_TAG" >> $GITHUB_OUTPUT
          echo "Selected server tag: $FIRST_TAG"

  # Job 2: Deploy lÃªn DigitalOcean
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DIGITALOCEAN_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment script
        env:
          CLIENT_IMAGE: ${{ needs.build-and-push.outputs.client_image }}
          SERVER_IMAGE: ${{ needs.build-and-push.outputs.server_image }}
        run: |
          cat << 'EOF' > deploy-remote.sh
          #!/bin/bash
          set -e

          echo "=== Starting Deployment ==="
          echo "Time: $(date)"
          echo "Branch: $GITHUB_REF_NAME"
          echo "Commit: $GITHUB_SHA"
          echo "Client Image: $CLIENT_IMAGE"
          echo "Server Image: $SERVER_IMAGE"

          # Navigate to app directory
          cd $APP_DIR

          # Pull latest code (for docker-compose files and configs)
          echo "=== Pulling latest code ==="
          git fetch origin
          git reset --hard origin/$GITHUB_REF_NAME

          # Login to GitHub Container Registry
          echo "=== Logging in to GitHub Container Registry ==="
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

          # Remove old containers and images to force fresh pull
          echo "=== Removing old containers and images ==="
          docker compose -f docker-compose.prod.yml down --rmi local || true
          docker image prune -f || true

          # Pull pre-built images (force pull, no cache)
          echo "=== Pulling pre-built Docker images ==="
          docker pull "$CLIENT_IMAGE" --no-cache || echo "Warning: Failed to pull client image"
          docker pull "$SERVER_IMAGE" --no-cache || echo "Warning: Failed to pull server image"

          # Tag images for docker-compose
          echo "=== Tagging images ==="
          docker tag "$CLIENT_IMAGE" ghcr.io/$GITHUB_REPOSITORY/client:latest
          docker tag "$SERVER_IMAGE" ghcr.io/$GITHUB_REPOSITORY/server:latest

          # Navigate to deploy directory
          cd deploy

          # Build deploy flags (skip backup if requested, always skip build)
          DEPLOY_FLAGS="--no-build"
          if [ "$SKIP_BACKUP" = "true" ]; then
            DEPLOY_FLAGS="$DEPLOY_FLAGS --skip-backup"
          fi

          # Run deploy script
          echo "=== Running deploy script with flags: $DEPLOY_FLAGS ==="
          bash digitalocean/scripts/deploy.sh $DEPLOY_FLAGS

          echo "=== Deployment completed successfully ==="
          EOF
          chmod +x deploy-remote.sh

      - name: Deploy to DigitalOcean VPS
        env:
          SKIP_BACKUP: ${{ github.event.inputs.skip_backup || 'false' }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          CLIENT_IMAGE: ${{ needs.build-and-push.outputs.client_image }}
          SERVER_IMAGE: ${{ needs.build-and-push.outputs.server_image }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ secrets.DIGITALOCEAN_HOST }} \
            "export APP_DIR='${{ env.APP_DIR }}' && \
             export SKIP_BACKUP='$SKIP_BACKUP' && \
             export GITHUB_REF_NAME='$GITHUB_REF_NAME' && \
             export GITHUB_SHA='$GITHUB_SHA' && \
             export CLIENT_IMAGE='$CLIENT_IMAGE' && \
             export SERVER_IMAGE='$SERVER_IMAGE' && \
             export GITHUB_TOKEN='$GITHUB_TOKEN' && \
             export GITHUB_ACTOR='$GITHUB_ACTOR' && \
             export GITHUB_REPOSITORY='$GITHUB_REPOSITORY' && \
             bash -s" < deploy-remote.sh

      - name: Health Check
        run: |
          echo "=== Running health check ==="
          sleep 30
          
          # Check if health endpoint responds
          HEALTH_URL="${{ secrets.APP_URL }}/api/v1/health"
          
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Checking $HEALTH_URL"
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Waiting 10 seconds before retry..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: Notify on Success
        if: success()
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "- Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- URL: ${{ secrets.APP_URL }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "- Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"

  # Job 3: Rollback náº¿u cáº§n (chá»‰ cháº¡y khi deploy fail)
  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DIGITALOCEAN_HOST }} >> ~/.ssh/known_hosts

      - name: Attempt Rollback
        run: |
          echo "=== Attempting rollback ==="
          ssh ${{ env.DEPLOY_USER }}@${{ secrets.DIGITALOCEAN_HOST }} << 'EOF'
            cd ${{ env.APP_DIR }}
            
            # Get previous commit
            PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
            echo "Rolling back to commit: $PREVIOUS_COMMIT"
            
            # Reset to previous commit
            git reset --hard $PREVIOUS_COMMIT
            
            # Restart containers without rebuild
            cd deploy
            docker compose -f docker-compose.prod.yml restart
            
            echo "Rollback completed"
          EOF
