services:
    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: restaurant_postgres
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - /mnt/volume/postgres:/var/lib/postgresql/data
        ports:
            - "127.0.0.1:5432:5432"
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 512M
                reservations:
                    memory: 256M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Redis Cache
    redis:
        image: redis:7-alpine
        container_name: restaurant_redis
        restart: unless-stopped
        command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
        ports:
            - "127.0.0.1:6379:6379"
        volumes:
            - /mnt/volume/redis:/data
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s
        deploy:
            resources:
                limits:
                    cpus: '0.25'
                    memory: 128M
                reservations:
                    memory: 64M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Backend Server
    server:
        image: ghcr.io/${GITHUB_REPOSITORY}/server:latest
        container_name: restaurant_server
        restart: unless-stopped
        build:
            context: ./app/server
            dockerfile: Dockerfile
        environment:
            NODE_ENV: production
            PORT: 5000
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public&connect_timeout=10&pool_timeout=10
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
            JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
            CLIENT_URL: ${CLIENT_URL}
            API_VERSION: ${API_VERSION:-v1}
            API_BASE_URL: ${API_BASE_URL}
            REDIS_URL: redis://redis:6379
            STORAGE_TYPE: ${STORAGE_TYPE:-r2}
            # Cloudflare R2 (Primary)
            R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
            R2_BUCKET_NAME: ${R2_BUCKET_NAME}
            R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
            R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
            R2_PUBLIC_URL: ${R2_PUBLIC_URL}
            # Cloudinary (Legacy)
            CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME:-}
            CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY:-}
            CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET:-}
        ports:
            - "127.0.0.1:5000:5000"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - restaurant_network
        volumes:
            - /mnt/volume/logs:/app/logs
            - /mnt/volume/uploads:/app/uploads
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        deploy:
            resources:
                limits:
                    cpus: '0.75'
                    memory: 512M
                reservations:
                    memory: 256M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Frontend Client
    client:
        image: ghcr.io/${GITHUB_REPOSITORY}/client:latest
        container_name: restaurant_client
        restart: unless-stopped
        build:
            context: ./app/client
            dockerfile: Dockerfile
        environment:
            NODE_ENV: production
            NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
            NEXT_PUBLIC_SOCKET_URL: ${NEXT_PUBLIC_SOCKET_URL}
        ports:
            - "127.0.0.1:3000:3000"
        depends_on:
            server:
                condition: service_healthy
        networks:
            - restaurant_network
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 512M
                reservations:
                    memory: 256M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

networks:
    restaurant_network:
        driver: bridge
